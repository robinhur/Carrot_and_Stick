<!DOCTYPE html>
<html>
<head>
<script src="https://www.gstatic.com/firebasejs/3.5.2/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCgQHDJ5lBrYybWdxFSube7QVC7sPohVzU",
    authDomain: "carotandstick-35d0e.firebaseapp.com",
    databaseURL: "https://carotandstick-35d0e.firebaseio.com",
    storageBucket: "carotandstick-35d0e.appspot.com",
    messagingSenderId: "93332277132"
  };
  firebase.initializeApp(config);
  console.log("initializeApp() called");
  
	firebase.auth().onAuthStateChanged(function(user) {
	  if (user) {
		// User is signed in.
		console.log("onAuthStateChanged : signed in");
		document.getElementById("input_email").value = user.email;
		document.getElementById("input_password").disabled = true;
		document.getElementById("btn_login").style.visibility = "hidden";
		document.getElementById("btn_logout").style.visibility = "visible";
		
		document.getElementById("connected").style.visibility = "visible";
		
				
		firebase.database().ref('/users/' + firebase.auth().currentUser.uid).once('value').then(function(snapshot) {
		  document.getElementById("user_name").value = snapshot.val().name;
		  document.getElementById("user_credit").value = snapshot.val().credit;
		  // ...
		});
				
		var creditRef = firebase.database().ref('/users/' + firebase.auth().currentUser.uid);
		creditRef.on('child_changed', function(data) {
			if (data.key == 'credit')
				document.getElementById("user_credit").value = data.val();
		});
		
		
	  } else {
		// No user is signed in.
		console.log("onAuthStateChanged : no user");
		document.getElementById("input_email").value = "";
		document.getElementById("input_password").value = "";
		document.getElementById("input_password").disabled = false;
	  }
	});
  
  
  function login_user() {
	
	console.log("login_user() called");
  
	var email = document.getElementById("input_email").value;
	var password = document.getElementById("input_password").value;
  
	firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
		// Handle Errors here.
		var errorCode = error.code;
		var errorMessage = error.message;
		console.log("login_user : errorCode = " + errorCode);
		console.log("login_user : errorMessage = " + errorMessage);
			
		alert(errorMessage);
		
	});
  
  }
  
  function logout_user() {
	
	console.log("logout_user() called");
  
	firebase.auth().signOut().then(function() {
	// Sign-out successful.
		document.getElementById("connected").style.visibility = "hidden";
		document.getElementById("input_email").value = "";
		document.getElementById("input_password").disabled = false;
		document.getElementById("input_password").value = "";
		document.getElementById("btn_login").style.visibility="visible";
		document.getElementById("btn_logout").style.visibility="hidden";
	}, function(error) {
	// An error happened.
	});

  }
  
  function add_credit() {
	
	console.log("add_credit() called");
  
	var add_value = parseInt(document.getElementById("add_credit").value);
	
	if (parseInt(document.getElementById("user_credit").value)+add_value < 0){
		document.getElementById("add_credit").value = "";
	} else {
	
		var result = parseInt(document.getElementById("user_credit").value)+add_value;
		firebase.database().ref('/users/' + firebase.auth().currentUser.uid).update({
			credit: result
		});
		document.getElementById("add_credit").value = "";
	
	}
  }
  
</script>
</head>
<body>

<div id="login">

<form>
Email address :&nbsp;
<input id="input_email" name="email address"/><br>
Password :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<input id="input_password" type="password" sname="password"/>
<input id="btn_login" type="button" value="Login" onclick="login_user();">
<input id="btn_logout" type="button" value="Logout" onclick="logout_user();" style="visibility:hidden">
</form>

<br><br>

<div id="connected" style="visibility:hidden">
	Name : <input id="user_name" type="name" name="user_name"/><br>
	Credit : <input id="user_credit" type="number" name="user_credit"/>
	<br><br>
	Add credit : <input id="add_credit" type="number" name="add_credit"/>
	<input id="btn_add" type="button" value="Add" onClick="add_credit();">
</div>

</body>
</html>

